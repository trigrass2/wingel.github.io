---
layout: post
title: SD Sniffer
date: '2011-11-15T21:59:00.008+01:00'
author: Christer Weinigel
tags:
- nerdy stuff
- hardware hacking
- SD bus
modified_time: '2011-11-27T22:49:04.670+01:00'
thumbnail: http://3.bp.blogspot.com/-aVy4IP_Mk14/TsLMLERnopI/AAAAAAAAACk/uUlIaQoWeJA/s72-c/sd-sniff-v1-sch.png
blogger_id: tag:blogger.com,1999:blog-4618495377058807667.post-6933073284981773926
blogger_orig_url: http://blog.weinigel.se/2011/11/sd-sniffer.html
---

I need to debug a problem with a SD bus.&nbsp; I have previously used a <a href="http://www.usbee.com/sx.html" target="_blank">USBee SX</a> with a custom firmware to sniff the bus and save a trace of all the SD signals to the hard drive so I could analyse them offline.&nbsp; This works fine up to about 30MHz but then the USBee runs out of bandwidth to the host PC.&nbsp; But the SD standard version 2 allows the bus to run at up to 50MHz and also tightens the electrical requirements for the SD bus, limiting impedance and capacitance so that the bus reliably can run at such high speeds.&nbsp; So for modern cards the USBee can't keep up and the long wires to the USBee can introduce a bit too much loading and deteriorate the signals so much that the SD card will no longer work.<br /><br />So I decided to build an adapter card which has a bunch of high impedance comparators sitting very close to the SD bus wires so that I can sniff the bus while changing the signals as little as possible.&nbsp; The signals will then be fed into an <a href="http://www.opalkelly.com/products/xem3001/" target="_blank">OpalKelly XEM3001 FPGA Board</a> that I happen to have lying around.&nbsp; Anyway, since I have lost the source code that I used before to do the sniffing and analysis I have to rewrite everything anyway, so why not get a bit overambitious, I mean, what's the fun in doing the same thing over again?<br /><br />Time to fire up <a href="http://www.cadsoftusa.com/" target="_blank">Eagle</a> and throw together some schematics.&nbsp; The SD bus is available on a pin header on the board I'm debugging so I'm using the same pin header on my board.&nbsp; Then I've put a SD card holder on the PCB so that I can plug a normal SD card into it.&nbsp; Then there are a bunch of comparators, one for each signal on the SD bus, and then a D/A converter which gives the comparators a reference voltage to compare the SD signals with.&nbsp; The outputs from the comparators go to a another pin header which matches the ZBUS connector on the OpalKelly board.&nbsp; The comparators and the D/A are powered from the OpalKelly board.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-aVy4IP_Mk14/TsLMLERnopI/AAAAAAAAACk/uUlIaQoWeJA/s1600/sd-sniff-v1-sch.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="300" src="http://3.bp.blogspot.com/-aVy4IP_Mk14/TsLMLERnopI/AAAAAAAAACk/uUlIaQoWeJA/s400/sd-sniff-v1-sch.png" width="400" />&nbsp;</a></div>Next the PCB design.&nbsp; It did take quite a bit of time to squeeze everything onto a 2 layer board, but hopefully it'll all work.<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-uKakhF47-Ac/TsLO68uPZxI/AAAAAAAAACs/ktSrtqr1_Xs/s1600/sd-sniff-v1-brd.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="240" src="http://1.bp.blogspot.com/-uKakhF47-Ac/TsLO68uPZxI/AAAAAAAAACs/ktSrtqr1_Xs/s320/sd-sniff-v1-brd.png" width="320" /></a></div>Some of the symbols and footprints I'm using are from the <a href="https://github.com/sparkfun/SparkFun-Eagle-Library" target="_blank">SparkFun Eagle library</a>.&nbsp; I found the SD connector footprint on some forum on the net that I can't manage to find again.<br /><br />I then mailed off the gerber files to a PCB manufacturer and settled down to wait.&nbsp; 14 days later the finished PCBs arrived in the mail.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-qzFFpFCFhx4/TsLQgsjz9xI/AAAAAAAAADM/GihRbFHp2fk/s1600/sd-sniffer-v1-bot.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="200" src="http://4.bp.blogspot.com/-qzFFpFCFhx4/TsLQgsjz9xI/AAAAAAAAADM/GihRbFHp2fk/s200/sd-sniffer-v1-bot.jpg" width="197" /></a><a href="http://2.bp.blogspot.com/-MbO9a2eJSOQ/TsLQkuTUh0I/AAAAAAAAADU/yEYbvtSHS6Y/s1600/sd-sniffer-v1-top.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="200" src="http://2.bp.blogspot.com/-MbO9a2eJSOQ/TsLQkuTUh0I/AAAAAAAAADU/yEYbvtSHS6Y/s200/sd-sniffer-v1-top.jpg" width="197" /></a></div><br />This is the first time I've used <a href="http://iteadstudio.com/">iteadstudio.com</a> and the results look quite good, so I'll definitely be using them again.<br /><br />So the first thing I did was to solder the pin header and SD holder in place, and then put a SD card in the SD holder and plug the board into the SD bus, this way I could verify that the board would work as a plain SD extender:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-vVSMRjsoy4A/TsLSDJb-5bI/AAAAAAAAADc/PMNeci0Hlp4/s1600/sd-sniff-v1-1.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="240" src="http://4.bp.blogspot.com/-vVSMRjsoy4A/TsLSDJb-5bI/AAAAAAAAADc/PMNeci0Hlp4/s320/sd-sniff-v1-1.jpg" width="320" /></a></div><br />And it did!&nbsp; At least with an old an slow SD card.<br /><br />So next up, test this with a modern high speed SD card running at 50MHz.&nbsp; And after that, start soldering some active components onto the board.<br /><br />This post is continued in <a href="http://blog.weinigel.se/2011/11/sd-sniffer-part-2.html">part 2</a>.