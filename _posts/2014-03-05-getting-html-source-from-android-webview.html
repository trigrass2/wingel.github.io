---
layout: post
title: Getting the HTML source from an Android WebView
date: '2014-03-05T01:40:00.000+01:00'
author: Christer Weinigel
tags: 
modified_time: '2014-03-05T02:01:05.255+01:00'
blogger_id: tag:blogger.com,1999:blog-4618495377058807667.post-2915903775355369815
permalink: /2014/03/getting-html-source-from-android-webview.html
---

<div class="tr_bq">On and off I'm working on writing an <a href="http://blog.weinigel.se/2013/10/weader-simple-atomrss-feed-reader-for.html">Atom/RSS feed reader</a> for Android. The feed reader is using an Android WebView to display the contents of a feed and to be able to debug some issues I had I wanted to be able to view the HTML source for a page.</div><br />That's should be simple I though, just do WebView.getData() and show it in a dialog. But no, there's no method to get the HTML source from a WebView, so one has to jump through a <a href="http://lexandera.com/2009/01/extracting-html-from-a-webview/">lot of hoops</a> to do that.  Also the examples I found uses WebView.addJavaScriptInterface to do its job which is not such a good idea because addJavaScriptInterface has <a href="http://blogs.avg.com/mobile/analyzing-android-webview-exploit/">security problems</a> and <a href="http://www.jasonshah.com/handling-android-2-3-webviews-broken-addjavascriptinterface/">doesn't even work on Android 2.3</a>.  And I do want my application to run on fairly old Android devices (I still use a Motorola Defy at work, I like the form factor and that it's waterproof).<br /><br />So after a bit of thinking I figured out an easier way of getting the source.  There is a class called WebViewClient which among other things can be used to override what should happen when a follows a link in the WebView.  This together with a bit of JavaScript can be used to get the source.<br /><br />First, when initializing the WebView, tell it to use a custom WebViewClient:<br /><br /><pre style="background-image: URL(http://2.bp.blogspot.com/_z5ltvMQPaa8/SjJXr_U2YBI/AAAAAAAAAAM/46OqEP32CJ8/s320/codebg.gif); background: #f0f0f0; border: 1px dashed #CCCCCC; color: black; font-family: arial; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> mWebView = (WebView) mView.findViewById(R.id.web);  <br /> mWebView.setWebViewClient(new MyWebViewClient());  <br /></code></pre><br />When asked to view the source, enable JavaScript for the WebView and then inject a bit of JavaScript which builds and follows an URL containing the HTML:<br /><br /><pre style="background-image: URL(http://2.bp.blogspot.com/_z5ltvMQPaa8/SjJXr_U2YBI/AAAAAAAAAAM/46OqEP32CJ8/s320/codebg.gif); background: #f0f0f0; border: 1px dashed #CCCCCC; color: black; font-family: arial; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> public void viewSource() {  <br />   mWebView.getSettings().setJavaScriptEnabled(true);  <br />   mWebView.loadUrl(  <br />     "javascript:this.document.location.href = 'source://' + encodeURI(document.documentElement.outerHTML);");  <br /> }  <br /></code></pre><br />The custom WebViewClient will catch this URL:<br /><br /><pre style="background-image: URL(http://2.bp.blogspot.com/_z5ltvMQPaa8/SjJXr_U2YBI/AAAAAAAAAAM/46OqEP32CJ8/s320/codebg.gif); background: #f0f0f0; border: 1px dashed #CCCCCC; color: black; font-family: arial; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> public class MyWebViewClient extends WebViewClient {  <br />     public boolean shouldOverrideUrlLoading(WebView view, String url) {<br />         if (url.startsWith("source://")) {<br />             try {<br />                 String html = URLDecoder.decode(url, "UTF-8").substring(9);<br />                 sourceReceived(html);<br />             } catch (UnsupportedEncodingException e) {<br />                 Log.e("example", "failed to decode source", e);<br />             }<br />             mWebView.getSettings().setJavaScriptEnabled(false);<br />             return true;<br />         }<br />         // For all other links, let the WebView do it's normal thing<br />         return false;<br />   }<br /> }<br /></code></pre><br />And we can finally show the source in a dialog: <br /><br /><pre style="background-image: URL(http://2.bp.blogspot.com/_z5ltvMQPaa8/SjJXr_U2YBI/AAAAAAAAAAM/46OqEP32CJ8/s320/codebg.gif); background: #f0f0f0; border: 1px dashed #CCCCCC; color: black; font-family: arial; font-size: 12px; height: auto; line-height: 20px; overflow: auto; padding: 0px; text-align: left; width: 99%;"><code style="color: black; word-wrap: normal;"> private void sourceReceived(String html) {  <br />   AlertDialog.Builder builder = new AlertDialog.Builder(this);  <br />   builder.setMessage(html);  <br />   builder.setTitle("View Source");  <br />   AlertDialog dialog = builder.create();  <br />   dialog.show();  <br /> }  <br /></code></pre><br />As simple as that.  And it seems to work on everything from Android 2.3 up to Android 4.4. <br /><br />Although what we get from the WebView does not quite seem to be the source code it was fed to begin with.  It seems that the WebView will fix up the HTML so that it is correct and will also decode any entitydefs.  So for example if the WebView was fed "&lt;p&gt;Hello W&amp;ouml;rld&lt;p&gt;" what we would get back is "&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;Hello WÃ¶rld&lt;p&gt;&lt;/body&gt;&lt;/html&gt;".  It's still useful for what I wanted to do though.<br /><br />